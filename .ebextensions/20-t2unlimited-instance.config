files:
  "/tmp/t2-test.sh":
    mode: "000755"
    content: |
      #!/bin/bash
      instanceType=$(TOKEN=`curl -X PUT "http://169.254.169.254/latest/api/token" -H \
         "X-aws-ec2-metadata-token-ttl-seconds: 21600"` \
         && curl -H "X-aws-ec2-metadata-token: $TOKEN" -v \
         http://169.254.169.254/latest/meta-data/instance-type)
      if [[ "$instanceType" =~ ^t2\. ]]
      then
        exit 0
      else
        exit 1
      fi

container_commands:
  set-t2-unlimited:
    command: |
      aws ec2 modify-instance-credit-specification --region \
      $(TOKEN=`curl -X PUT "http://169.254.169.254/latest/api/token" -H \
      "X-aws-ec2-metadata-token-ttl-seconds: 21600"` \
      && curl -H "X-aws-ec2-metadata-token: $TOKEN" -v \
      http://169.254.169.254/latest/meta-data/placement/availability-zone | sed 's/[a-z]$//') \
      --instance-credit-specification \
      '[{"InstanceId": "'"$(TOKEN=`curl -X PUT "http://169.254.169.254/latest/api/token" -H \
      "X-aws-ec2-metadata-token-ttl-seconds: 21600"` \
      && curl -H "X-aws-ec2-metadata-token: $TOKEN" -v \
      http://169.254.169.254/latest/meta-data/instance-id)"'","CpuCredits": "unlimited"}]'
    test: "[ /tmp/t2-test.sh ]"
