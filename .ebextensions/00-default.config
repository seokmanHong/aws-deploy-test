commands:
  set_time_zone:
    command: ln -f -s /usr/share/zoneinfo/Asia/Seoul /etc/localtime
  99file_size:
    command: "rm -f /etc/php.d/99uploadsize.ini.bak"

files:
  "/etc/php.d/99uploadsize.ini":
    mode: "000644"
    owner: root
    group: root
    content: |
        upload_max_filesize=10M
        post_max_size=10M
  "/tmp/t2-test.sh":
    mode: "000755"
    content: |
      #!/bin/bash
      instanceType=$(curl -s http://169.254.169.254/latest/meta-data/instance-type)
      if [[ "$instanceType" =~ ^t2\. ]]
      then
        exit 0
      else
        exit 1
      fi

container_commands:
  10_permission:
    command: "mkdir /var/app/current/storage/logs/sql; chown webapp:webapp /var/app/current/storage/logs/sql"
  20_migration:
    command: "php /var/app/current/artisan migrate --force"
    test: '[[ $SERVER_ROLE = "master" ]]'

  90_set-t2-unlimited:
    command: |
      aws ec2 modify-instance-credit-specification --region \
      $(TOKEN=`curl -X PUT "http://169.254.169.254/latest/api/token" -H \
      "X-aws-ec2-metadata-token-ttl-seconds: 21600"` \
      && curl -H "X-aws-ec2-metadata-token: $TOKEN" -v \
      http://169.254.169.254/latest/meta-data/placement/availability-zone | sed 's/[a-z]$//') \
      --instance-credit-specification \
      '[{"InstanceId": "'"$(TOKEN=`curl -X PUT "http://169.254.169.254/latest/api/token" -H \
      "X-aws-ec2-metadata-token-ttl-seconds: 21600"` \
      && curl -H "X-aws-ec2-metadata-token: $TOKEN" -v \
      http://169.254.169.254/latest/meta-data/instance-id)"'","CpuCredits": "unlimited"}]'
    test: "[ /tmp/t2-test.sh ]"
